<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Calendario de Clases</title>

  <!-- FullCalendar -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/index.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.19/locales/es.global.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; background: #f5f6fa; margin:0; padding:0; }
    .container { max-width:1200px; margin:20px auto; padding:0 20px; }
    .header { display:flex; justify-content: space-between; align-items:center; margin-bottom:10px; }
    .filters { display:flex; gap:10px; }
    select { padding:5px 10px; border-radius:5px; border:1px solid #ccc; }
    #calendar { background:white; border-radius:10px; padding:10px; box-shadow:0 2px 8px rgba(0,0,0,0.1); }
  </style>
</head>
<body>

<div class="container">
  <div class="header">
    <h2>ðŸ“… Calendario de Clases</h2>
    <div class="filters">
      <select id="filterTutor"><option value="">Todos los tutores</option></select>
      <select id="filterAlumno"><option value="">Todos los alumnos</option></select>
      <select id="filterCurso"><option value="">Todos los cursos</option></select>
      <select id="filterModalidad"><option value="">Todas las modalidades</option></select>
    </div>
  </div>
  <div id="calendar"></div>
</div>

<script>
async function loadJSON(url){
  const resp = await fetch(url);
  return resp.json();
}

function generateRegularEvents(regular, excepciones){
  const events = [];
  const excluidos = excepciones.map(e => e.Fecha);

  regular.forEach(r => {
    const inicio = new Date(r.Inicio_Contrato);
    const fin = new Date(r.Fin_Contrato);
    const diaSemana = parseInt(r.Dia_Semana);

    let current = new Date(inicio);
    while(current <= fin){
      const dayOfWeek = current.getDay() === 0 ? 7 : current.getDay();
      const fechaStr = current.toISOString().slice(0,10);
      if(dayOfWeek === diaSemana && !excluidos.includes(fechaStr)){
        events.push({
          id: r.ID_Regular + '-' + fechaStr.replace(/-/g,''),
          title: `${r.Alumno} â€¢ ${r.Curso} (${r.Modalidad})`,
          start: fechaStr + 'T' + r.Hora_Inicio,
          end: fechaStr + 'T' + r.Hora_Final,
          extendedProps: r
        });
      }
      current.setDate(current.getDate() + 1);
    }
  });
  return events;
}

function generateEventualEvents(eventual){
  return eventual.map(r => ({
    id: r.ID_Evento,
    title: `${r.Alumno} â€¢ ${r.Curso} (${r.Modalidad})`,
    start: r.Fecha + 'T' + r.Hora_Inicio,
    end: r.Fecha + 'T' + r.Hora_Final,
    extendedProps: r
  }));
}

function formatWeekTitle(start, end){
  const startDay = start.getDate();
  const endDay = new Date(end.getTime() - 1).getDate();
  const monthYear = start.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' }).toUpperCase();
  return `${startDay} â€“ ${endDay} ${monthYear}`;
}

async function initCalendar(){
  const regular = await loadJSON('regular.json');
  const eventual = await loadJSON('eventual.json');
  const excepciones = await loadJSON('excepcion.json');

  const events = [
    ...generateRegularEvents(regular, excepciones),
    ...generateEventualEvents(eventual)
  ];

  const calendarEl = document.getElementById('calendar');
  const calendar = new FullCalendar.Calendar(calendarEl, {
    initialView:'timeGridWeek',
    locale:'es',
    nowIndicator:true,
    firstDay:1,
    slotMinTime:'06:00:00',
    slotMaxTime:'22:00:00',
    headerToolbar: { left:'prev,next today', center:'title', right:'timeGridWeek,listWeek' },
    events: events,

    // Encabezado diario: LUNES + nÃºmero
    dayHeaderContent: function(arg) {
      const dayName = arg.date.toLocaleDateString('es-ES', { weekday: 'long' }).toUpperCase();
      const date = arg.date.getDate();
      return { html: `${dayName}<br>${date}` };
    },

    // TÃ­tulo de la semana
    datesSet: function(info){
      const weekTitle = formatWeekTitle(info.view.currentStart, info.view.currentEnd);
      const headerEl = calendarEl.querySelector('.fc-toolbar-title');
      if(headerEl) headerEl.innerHTML = weekTitle;
    },

    // Contenido de cada evento
    eventContent: function(arg) {
      const props = arg.event.extendedProps;
      const start = arg.event.start;
      const end = arg.event.end;

      const formatTime = date => date.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
      const hora = `${formatTime(start)} - ${formatTime(end)}`;
      const alumno = `A: ${props.Alumno}`;
      const tutor = `T: ${props.Tutor}`;
      const modalidadCurso = `(${props.Modalidad}) - ${props.Curso}`;

      if(arg.view.type === 'listWeek'){
        // Vista Agenda: mostrar solo Alumno | Tutor | Modalidad-Curso
        return { html: `${alumno} | ${tutor} | ${modalidadCurso}` };
      } else {
        // Vista Semana: formato vertical con hora
        return { html: `<div style="font-size:13px; line-height:1.2;">
          ${hora}<br>${alumno}<br>${tutor}<br>${modalidadCurso}
        </div>` };
      }
    },

    // Colores segÃºn modalidad
    eventDidMount: function(info) {
      if(info.event.extendedProps.Modalidad.toLowerCase() === 'presencial'){
        info.el.style.backgroundColor = '#4a90e2'; // Azul
        info.el.style.color = 'white';
      } else if(info.event.extendedProps.Modalidad.toLowerCase() === 'virtual'){
        info.el.style.backgroundColor = '#27ae60'; // Verde
        info.el.style.color = 'white';
      }
      info.el.style.borderRadius = '5px';
    }
  });

  calendar.render();

  // Filtros
  const tutors = [...new Set(events.map(e=>e.extendedProps.Tutor))];
  const alumnos = [...new Set(events.map(e=>e.extendedProps.Alumno))];
  const cursos = [...new Set(events.map(e=>e.extendedProps.Curso))];
  const modalidades = [...new Set(events.map(e=>e.extendedProps.Modalidad))];

  const fillSelect = (id, arr)=>{
    const sel = document.getElementById(id);
    arr.forEach(v=>{
      const opt = document.createElement('option');
      opt.value=v; opt.textContent=v; sel.appendChild(opt);
    });
  };

  fillSelect('filterTutor', tutors);
  fillSelect('filterAlumno', alumnos);
  fillSelect('filterCurso', cursos);
  fillSelect('filterModalidad', modalidades);

  ['filterTutor','filterAlumno','filterCurso','filterModalidad'].forEach(id=>{
    document.getElementById(id).addEventListener('change', ()=>{
      const fTutor = document.getElementById('filterTutor').value;
      const fAlumno = document.getElementById('filterAlumno').value;
      const fCurso = document.getElementById('filterCurso').value;
      const fModalidad = document.getElementById('filterModalidad').value;

      const filtered = events.filter(e=>{
        return (!fTutor || e.extendedProps.Tutor===fTutor)
          && (!fAlumno || e.extendedProps.Alumno===fAlumno)
          && (!fCurso || e.extendedProps.Curso===fCurso)
          && (!fModalidad || e.extendedProps.Modalidad===fModalidad);
      });
      calendar.removeAllEvents();
      calendar.addEventSource(filtered);
    });
  });
}

initCalendar();
</script>

</body>
</html>
